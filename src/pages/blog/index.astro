---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import { getCollection } from 'astro:content';
import BlogPostCard from '../../components/ui/BlogPostCard.astro';

// Get all published blog posts
const allPosts = await getCollection('blog');
const publishedPosts = allPosts
  .filter(post => post.data.published !== false)
  .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

// Simplified filter categories
const filterCategories = ['All Posts', 'Federated Learning', 'Security', 'System Design'];

// Tag mapping for filtering
const categoryTagMap: Record<string, string[]> = {
  'all posts': [],
  'federated learning': ['federated-learning', 'fl'],
  'security': ['security', 'fraud-detection', 'banking'],
  'system design': ['cryptography', 'portfolio', 'tutorial']
};

// Calculate reading time from content or use provided value
function getReadingTime(post: typeof publishedPosts[0]): string {
  if (post.data.readingTime) {
    return `${post.data.readingTime} min read`;
  }
  // Estimate from content: ~200 words per minute
  const words = post.body.split(/\s+/).length;
  const minutes = Math.max(1, Math.ceil(words / 200));
  return `${minutes} min read`;
}

const title = 'Blog - Azka';
const description = 'Technical writing on federated learning security, adversarial machine learning, fraud detection, and AI safety research.';
---

<BaseLayout title={title} description={description}>
  <div class="section-padding">
    <div class="container-custom">
      <div class="max-w-4xl mx-auto text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 font-display text-text-primary">
          Blog
        </h1>
        <p class="text-xl text-text-muted">
          Technical writing on federated learning security, adversarial ML, and AI safety research
        </p>
      </div>

      <!-- Tags Filter -->
      <div class="flex flex-wrap justify-center gap-2 mb-10" id="tag-filters">
        {filterCategories.map((category) => (
          <button
            class:list={[
              "filter-btn px-4 py-2 rounded-lg font-medium text-sm transition-all",
              category === 'All Posts'
                ? "bg-accent text-white hover:shadow-lg hover:shadow-accent/20"
                : "bg-bg-secondary text-text-subtle border border-border-subtle hover:border-accent hover:text-accent"
            ]}
            data-filter={category.toLowerCase()}
          >
            {category}
          </button>
        ))}
      </div>

      <!-- Blog Posts Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="posts-grid">
        {publishedPosts.map((post) => (
          <BlogPostCard
            title={post.data.title}
            date={new Date(post.data.date).toISOString().split('T')[0]}
            displayDate={new Date(post.data.date).toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric'
            })}
            summary={post.data.description}
            readingTime={getReadingTime(post)}
            tags={post.data.tags}
            href={`/blog/${post.slug}`}
            data-tags={post.data.tags.join(',')}
          />
        ))}
      </div>

      <!-- Empty State -->
      {publishedPosts.length === 0 && (
        <div class="text-center py-16">
          <p class="text-text-muted text-lg">No blog posts yet. Check back soon!</p>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<script define:vars={{ categoryTagMap }}>
  // Simplified category filtering
  const filterButtons = document.querySelectorAll('.filter-btn');
  const postCards = document.querySelectorAll('[data-tags]');

  filterButtons.forEach(button => {
    button.addEventListener('click', () => {
      const filter = (button.dataset.filter || 'all posts').toLowerCase();

      // Update active state
      filterButtons.forEach(btn => {
        btn.classList.remove('bg-accent', 'text-white', 'hover:shadow-lg', 'hover:shadow-accent/20');
        btn.classList.add('bg-bg-secondary', 'text-text-subtle', 'border', 'border-border-subtle');
      });
      button.classList.remove('bg-bg-secondary', 'text-text-subtle', 'border', 'border-border-subtle');
      button.classList.add('bg-accent', 'text-white', 'hover:shadow-lg', 'hover:shadow-accent/20');

      // Filter posts by category mapping
      const mappingTags = categoryTagMap[filter] || [];

      postCards.forEach(card => {
        const cardTags = (card.dataset.tags || '').toLowerCase();
        const shouldShow = filter === 'all posts' || mappingTags.some(tag => cardTags.includes(tag));
        card.style.display = shouldShow ? 'flex' : 'none';
      });
    });
  });
</script>
